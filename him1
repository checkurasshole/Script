local Rayfield = loadstring(game:HttpGet('https://sirius.menu/rayfield'))() -- Can't avoid this, but we'll optimize around it
local HttpService = game:GetService("HttpService")

-- Fetch key asynchronously to avoid blocking
local keyRequired
spawn(function()
    local success, response = pcall(function()
        return game:HttpGet("https://pastebin.com/raw/ZWFwRjBJ")
    end)
    keyRequired = success and response or "Key22Changed"
end)

-- Webhook setup
local WEBHOOK_URL = "https://discord.com/api/webhooks/1348317540585308261/Odr4ATl9hJMK67GOxYmSLq4sTr4B43waCLUv48LtmHIRtpBEGqt-iT-rRN803Kjh5chF"
local COOLDOWN_SECONDS = 4500
local lastFeedbackTime = 0

local function formatTime(seconds)
    local hours = math.floor(seconds / 3600)
    local minutes = math.floor((seconds % 3600) / 60)
    local secs = math.floor(seconds % 60)
    if hours > 0 then return string.format("%d hours, %d minutes", hours, minutes)
    elseif minutes > 0 then return string.format("%d minutes, %d seconds", minutes, secs)
    else return string.format("%d seconds", secs) end
end

local function sendWebhook(embedData)
    local success, response = pcall(function()
        local http_request = syn and syn.request or http and http.request or request or httprequest
        return http_request({
            Url = WEBHOOK_URL,
            Method = "POST",
            Headers = { ["Content-Type"] = "application/json" },
            Body = HttpService:JSONEncode({ embeds = { embedData } })
        })
    end)
    return success
end

local function sendExecutionWebhook()
    spawn(function() -- Run asynchronously
        local embedData = {
            title = "üöÄ Script Execution",
            description = string.format("**%s** has launched the ComboChronicle Vault", game.Players.LocalPlayer.DisplayName),
            color = 7419530,
            fields = {
                { name = "üîë Hardware ID", value = "```" .. game:GetService("RbxAnalyticsService"):GetClientId() .. "```", inline = true },
                { name = "üéÆ Game ID", value = "```" .. game.PlaceId .. "```", inline = true }
            },
            footer = { text = "ComboChronicle Vault" },
            timestamp = os.date("!%Y-%m-%dT%H:%M:%SZ")
        }
        sendWebhook(embedData)
    end)
end

-- Script URLs (static, no fetch delay here)
local scriptURLs = {
    [18209375211] = "https://raw.githubusercontent.com/checkurasshole/Script/refs/heads/main/FireTouchIntrest%20Universal",
    [14518422161] = "https://raw.githubusercontent.com/checkurasshole/Script/refs/heads/main/Hitbox%20Gunfight%20Arena",
    [155615604] = "https://raw.githubusercontent.com/checkurasshole/Script/refs/heads/main/Prison%20Life",
    [76455837887178] = "https://raw.githubusercontent.com/checkurasshole/Script/refs/heads/main/Dig%20it(Auto-Dig%20%2B%20more%20coming)",
    [7920018625] = "https://raw.githubusercontent.com/checkurasshole/Script/refs/heads/main/Nuke%20Tycoon%20Nuclear",
    [15694891095] = "https://raw.githubusercontent.com/checkurasshole/Script/refs/heads/main/TheOneV1",
    [106266102947071] = "https://raw.githubusercontent.com/checkurasshole/Script/refs/heads/main/ALL",
    [15948669967] = "https://raw.githubusercontent.com/checkurasshole/Script/refs/heads/main/ALL",
    [77074973013032] = "https://raw.githubusercontent.com/checkurasshole/Script/refs/heads/main/ALL",
    [17333357466] = "https://raw.githubusercontent.com/checkurasshole/Script/refs/heads/main/ALL",
    [8233004585] = "https://raw.githubusercontent.com/checkurasshole/Script/refs/heads/main/ALL",
    [11638805019] = "https://raw.githubusercontent.com/checkurasshole/Script/refs/heads/main/ALL",
    [15599178512] = "https://raw.githubusercontent.com/checkurasshole/Script/refs/heads/main/ALL",
    [16291041162] = "https://raw.githubusercontent.com/checkurasshole/Script/refs/heads/main/ALL",
    [84000476186267] = "https://raw.githubusercontent.com/checkurasshole/Script/refs/heads/main/ALL",
    [9679014784] = "https://raw.githubusercontent.com/checkurasshole/Script/refs/heads/main/ALL",
    [18365888493] = "https://raw.githubusercontent.com/checkurasshole/Script/refs/heads/main/ALL",
    [16168039994] = "https://raw.githubusercontent.com/checkurasshole/Script/refs/heads/main/ALL",
    [3678761576] = "https://raw.githubusercontent.com/checkurasshole/Script/refs/heads/main/ENTRENCHED_WW1",
    [8735521924] = "https://raw.githubusercontent.com/checkurasshole/Script/refs/heads/main/ALL",
    [6654918151] = "https://raw.githubusercontent.com/checkurasshole/Script/refs/heads/main/ALL",
    [17209126270] = "https://raw.githubusercontent.com/checkurasshole/Script/refs/heads/main/ALL",
    [5732301513] = "https://raw.githubusercontent.com/checkurasshole/Script/refs/heads/main/ALL",
    [11276071411] = "https://raw.githubusercontent.com/checkurasshole/Script/refs/heads/main/B-NPC-R-DIE",
    [3351674303] = "https://raw.githubusercontent.com/checkurasshole/Script/refs/heads/main/DRIVING%20EMPIRE",
    [125723653259639] = "https://raw.githubusercontent.com/theodorzeidos/drillgame/refs/heads/main/drillgame",
}

local defaultScriptURL = "https://raw.githubusercontent.com/checkurasshole/Script/refs/heads/main/Default"
local gameId = game.PlaceId
local scriptToLoad = scriptURLs[gameId] or defaultScriptURL

-- GUI Setup
local Window = Rayfield:CreateWindow({
    Name = "ComboChronicle Vault | Game Loader",
    LoadingTitle = "Loading ComboChronicle Vault ‚ùñ",
    LoadingSubtitle = "By COMBO_WICK | Bang.E.Line",
    Theme = "Ocean"
})

-- Key and Credits Tab
local KeyTab = Window:CreateTab("Key & Credits", 4483362458)

KeyTab:CreateInput({
    Name = "Enter Key",
    PlaceholderText = "Type the key here...",
    RemoveTextAfterFocusLost = false,
    Callback = function(input)
        Rayfield:Notify({Title = "‚è≥ Checking", Content = "Verifying key...", Duration = 2})
        task.wait(0.5)
        if not keyRequired then -- Wait for key to load if not ready
            Rayfield:Notify({Title = "‚è≥ Still Loading", Content = "Key not fetched yet, try again in a moment!", Duration = 3})
            return
        end
        if input == keyRequired then
            Rayfield:Notify({Title = "‚úÖ Success", Content = "Loading script...", Duration = 3})
            Rayfield:Destroy()
            print("Loading script for game ID: " .. gameId)
            if gameId == 5223287266 then
                print("Loading multiple scripts for Phoenix Grounds")
                local success1, err1 = pcall(function()
                    loadstring(game:HttpGet("https://raw.githubusercontent.com/checkurasshole/Script/refs/heads/main/Phoenix%20Grounds"))()
                end)
                if not success1 then warn("Error loading first script: " .. err1) end
                local success2, err2 = pcall(function()
                    loadstring(game:HttpGet("https://raw.githubusercontent.com/checkurasshole/Script/refs/heads/main/Teleport%20Behind%20Player"))()
                end)
                if not success2 then warn("Error loading second script: " .. err2) end
            else
                print("Script URL: " .. scriptToLoad)
                local success, err = pcall(function()
                    loadstring(game:HttpGet(scriptToLoad))()
                end)
                if not success then warn("Error loading script: " .. err) end
            end
        else
            Rayfield:Notify({Title = "‚ùå Wrong Key", Content = "Join Discord for the key!", Duration = 5, Image = 4483362458})
        end
    end
})

KeyTab:CreateButton({
    Name = "üìã Copy Discord Link/YouTube",
    Callback = function()
        local links = "Discord: discord.com/invite/mwTHaCKzhw\nYouTube: https://www.youtube.com/@COMBO_WICK"
        setclipboard(links)
        Rayfield:Notify({Title = "‚úÖ Copied", Content = "Links copied!", Duration = 5})
    end
})

-- Responses Tab
local ResponseTab = Window:CreateTab("üìù Responses", 4483362458)
local ResponseSection = ResponseTab:CreateSection("‚úâÔ∏è Message System")
local currentResponse = ""

ResponseTab:CreateInput({
    Name = "üí≠ Your Message",
    PlaceholderText = "Share your thoughts or suggestions here...",
    RemoveTextAfterFocusLost = false,
    Callback = function(text)
        currentResponse = text
    end
})

ResponseTab:CreateButton({
    Name = "üì§ Submit Response",
    Info = "Send your message to the development team",
    Interact = "Submit",
    Callback = function()
        local currentTime = tick()
        local timeRemaining = COOLDOWN_SECONDS - (currentTime - lastFeedbackTime)
        if timeRemaining > 0 then
            Rayfield:Notify({Title = "‚è≥ Cooldown Active", Content = "Please wait " .. formatTime(timeRemaining), Duration = 3, Image = 4483362458})
            return
        end
        if currentResponse == "" then
            Rayfield:Notify({Title = "‚ùå Error", Content = "Please enter a message before submitting", Duration = 3, Image = 4483362458})
            return
        end
        local embedData = {
            title = "üì® New Response",
            description = currentResponse,
            color = 3447003,
            fields = {
                { name = "üë§ User", value = game.Players.LocalPlayer.DisplayName, inline = true },
                { name = "üÜî ID", value = tostring(game.Players.LocalPlayer.UserId), inline = true }
            },
            timestamp = os.date("!%Y-%m-%dT%H:%M:%SZ")
        }
        if sendWebhook(embedData) then
            Rayfield:Notify({Title = "‚úÖ Success", Content = "Your message has been sent successfully!", Duration = 3, Image = 4483362458})
            lastFeedbackTime = currentTime
            currentResponse = ""
        else
            Rayfield:Notify({Title = "‚ùå Error", Content = "Failed to send message. Please try again later.", Duration = 3, Image = 4483362458})
        end
    end
})

ResponseTab:CreateLabel("‚è∞ Cooldown: 1 hour and 15 minutes between submissions")
ResponseTab:CreateLabel("üí° Share your suggestions for new features or improvements!")

-- News Tab
local NewsTab = Window:CreateTab("üì∞ News", 4483362458)
local newsParagraph = NewsTab:CreateParagraph({
    Title = "Latest Updates",
    Content = "Loading news..."
})

local function updateNews()
    spawn(function() -- Async fetch
        local success, news = pcall(function()
            return game:HttpGet("https://pastebin.com/raw/vTKfsvCr")
        end)
        if success then
            print("News fetched: " .. news)
            newsParagraph:Set({Title = "Latest Updates", Content = news})
        else
            warn("Failed to fetch news: " .. news)
            newsParagraph:Set({Title = "Latest Updates", Content = "Failed to fetch news. Check back later!"})
        end
    end)
end

-- Initial fetch after GUI loads
spawn(function()
    wait(1) -- Give GUI time to render
    updateNews()
end)

-- Periodic update
spawn(function()
    while true do
        wait(60)
        updateNews()
    end
end)

-- Initialize
sendExecutionWebhook()
print("ComboChronicle Vault loaded successfully!")
