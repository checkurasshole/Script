local Rayfield = loadstring(game:HttpGet('https://sirius.menu/rayfield'))()
local HttpService = game:GetService("HttpService")
local Players = game:GetService("Players")
local LocalPlayer = Players.LocalPlayer

-- Async key fetch
local keyRequired
spawn(function()
    local success, response = pcall(function()
        return game:HttpGet("https://pastebin.com/raw/ZWFwRjBJ")
    end)
    keyRequired = success and response or "Key22Changed"
end)

-- Subscription keys system
local SUBSCRIPTION_URL = "https://pastebin.com/raw/ThRPn5JG"
local subscribedUsers = {}
local function fetchSubscriptions()
    local success, data = pcall(function()
        return game:HttpGet(SUBSCRIPTION_URL)
    end)
    if success then
        print("Subscription data fetched: " .. data)
        for line in data:gmatch("[^\n]+") do
            local userId, expiry = line:match("(%d+):(%d+)")
            if userId and expiry then
                subscribedUsers[tonumber(userId)] = tonumber(expiry)
                print("Loaded subscription - UserID: " .. userId .. ", Expiry: " .. expiry)
            end
        end
    else
        warn("Failed to fetch subscriptions: " .. data)
    end
end
spawn(function() fetchSubscriptions() end)

local function isSubscribed(userId)
    local expiry = subscribedUsers[userId]
    if expiry and os.time() < expiry then
        print("User " .. userId .. " is subscribed until " .. expiry)
        return true
    end
    print("User " .. userId .. " is not subscribed or expired")
    return false
end

-- Webhook setup
local WEBHOOK_URL = "https://discord.com/api/webhooks/1348317540585308261/Odr4ATl9hJMK67GOxYmSLq4sTr4B43waCLUv48LtmHIRtpBEGqt-iT-rRN803Kjh5chF"
local COOLDOWN_SECONDS = 4500
local lastFeedbackTime = 0

local function formatTime(seconds)
    local hours = math.floor(seconds / 3600)
    local minutes = math.floor((seconds % 3600) / 60)
    local secs = math.floor(seconds % 60)
    if hours > 0 then return string.format("%d hours, %d minutes", hours, minutes)
    elseif minutes > 0 then return string.format("%d minutes, %d seconds", minutes, secs)
    else return string.format("%d seconds", secs) end
end

local function sendWebhook(embedData)
    local success = pcall(function()
        local http_request = syn and syn.request or http and http.request or request or httprequest
        http_request({
            Url = WEBHOOK_URL,
            Method = "POST",
            Headers = { ["Content-Type"] = "application/json" },
            Body = HttpService:JSONEncode({ embeds = { embedData } })
        })
    end)
    return success
end

local function sendExecutionWebhook()
    spawn(function()
        local embedData = {
            title = "ğŸš€ Script Execution",
            description = string.format("**%s** has launched the Vault", LocalPlayer.DisplayName),
            color = 7419530,
            fields = {
                { name = "ğŸ”‘ Hardware ID", value = "```" .. game:GetService("RbxAnalyticsService"):GetClientId() .. "```", inline = true },
                { name = "ğŸ® Game ID", value = "```" .. game.PlaceId .. "```", inline = true }
            },
            footer = { text = "ComboChronicle Vault" },
            timestamp = os.date("!%Y-%m-%dT%H:%M:%SZ")
        }
        sendWebhook(embedData)
    end)
end

-- Limited script URLs
local scriptURLs = {
    [14518422161] = "https://raw.githubusercontent.com/checkurasshole/Script/refs/heads/main/Hitbox%20Gunfight%20Arena",
    [155615604] = "https://raw.githubusercontent.com/checkurasshole/Script/refs/heads/main/Prison%20Life",
    [7920018625] = "https://raw.githubusercontent.com/checkurasshole/Script/refs/heads/main/Nuke%20Tycoon%20Nuclear",
}
local defaultScriptURL = "https://raw.githubusercontent.com/checkurasshole/Script/refs/heads/main/Default"
local gameId = game.PlaceId
local scriptToLoad = scriptURLs[gameId] or defaultScriptURL

-- VIP exclusive script (example)
local vipScriptURL = "https://raw.githubusercontent.com/checkurasshole/Script/refs/heads/main/VIP_Exclusive" -- Replace with a real VIP script URL

-- GUI Setup
local Window = Rayfield:CreateWindow({
    Name = "ComboChronicle Vault | NextGen",
    LoadingTitle = "Initializing Vault â–",
    LoadingSubtitle = "By COMBO_WICK | Bang.E.Line",
    Theme = "Ocean"
})

-- Key & Credits Tab
local KeyTab = Window:CreateTab("ğŸ”‘ Key & Credits", 4483362458)
KeyTab:CreateInput({
    Name = "Enter Key",
    PlaceholderText = "Type the key here...",
    RemoveTextAfterFocusLost = false,
    Callback = function(input)
        Rayfield:Notify({Title = "â³ Checking", Content = "Verifying key...", Duration = 2})
        task.wait(0.5)
        if not keyRequired then
            Rayfield:Notify({Title = "â³ Loading", Content = "Key not fetched yet!", Duration = 3})
            return
        end
        if input == keyRequired then
            Rayfield:Notify({Title = "âœ… Success", Content = "Access granted!", Duration = 3})
            Rayfield:Destroy()
            if gameId == 5223287266 then
                spawn(function() loadstring(game:HttpGet("https://raw.githubusercontent.com/checkurasshole/Script/refs/heads/main/Phoenix%20Grounds"))() end)
                spawn(function() loadstring(game:HttpGet("https://raw.githubusercontent.com/checkurasshole/Script/refs/heads/main/Teleport%20Behind%20Player"))() end)
            else
                spawn(function() loadstring(game:HttpGet(scriptToLoad))() end)
            end
        else
            Rayfield:Notify({Title = "âŒ Invalid", Content = "Join Discord for key!", Duration = 5, Image = 4483362458})
        end
    end
})
KeyTab:CreateButton({
    Name = "ğŸ“‹ Copy Links",
    Callback = function()
        setclipboard("Discord: discord.com/invite/mwTHaCKzhw\nYouTube: https://www.youtube.com/@COMBO_WICK")
        Rayfield:Notify({Title = "âœ… Copied", Content = "Links copied!", Duration = 5})
    end
})

-- Responses Tab
local ResponseTab = Window:CreateTab("ğŸ“ Responses", 4483362458)
local ResponseSection = ResponseTab:CreateSection("âœ‰ï¸ Message System")
local currentResponse = ""
ResponseTab:CreateInput({
    Name = "ğŸ’­ Your Message",
    PlaceholderText = "Share your thoughts...",
    RemoveTextAfterFocusLost = false,
    Callback = function(text) currentResponse = text end
})
ResponseTab:CreateButton({
    Name = "ğŸ“¤ Submit",
    Info = "Send to devs",
    Interact = "Submit",
    Callback = function()
        local currentTime = tick()
        local timeRemaining = COOLDOWN_SECONDS - (currentTime - lastFeedbackTime)
        if timeRemaining > 0 then
            Rayfield:Notify({Title = "â³ Cooldown", Content = "Wait " .. formatTime(timeRemaining), Duration = 3, Image = 4483362458})
            return
        end
        if currentResponse == "" then
            Rayfield:Notify({Title = "âŒ Error", Content = "Enter a message!", Duration = 3, Image = 4483362458})
            return
        end
        local embedData = {
            title = "ğŸ“¨ New Response",
            description = currentResponse,
            color = 3447003,
            fields = {
                { name = "ğŸ‘¤ User", value = LocalPlayer.DisplayName, inline = true },
                { name = "ğŸ†” ID", value = tostring(LocalPlayer.UserId), inline = true }
            },
            timestamp = os.date("!%Y-%m-%dT%H:%M:%SZ")
        }
        if sendWebhook(embedData) then
            Rayfield:Notify({Title = "âœ… Sent", Content = "Message delivered!", Duration = 3, Image = 4483362458})
            lastFeedbackTime = currentTime
            currentResponse = ""
        else
            Rayfield:Notify({Title = "âŒ Failed", Content = "Try again later.", Duration = 3, Image = 4483362458})
        end
    end
})
ResponseTab:CreateLabel("â° Cooldown: 1h 15m")
ResponseTab:CreateLabel("ğŸ’¡ Suggest features!")

-- News Tab
local NewsTab = Window:CreateTab("ğŸ“° News", 4483362458)
local newsParagraph = NewsTab:CreateParagraph({
    Title = "ğŸ—ï¸ Vault Updates",
    Content = "Loading news..."
})
local function formatNews(rawNews)
    if not rawNews or rawNews == "" then return "No news yet!" end
    local lines = {}
    for line in rawNews:gmatch("[^\n]+") do table.insert(lines, line) end
    local formatted = "âœ¨ Vault Chronicle âœ¨\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n"
    for i, line in ipairs(lines) do
        if line:match("^NEWS:") then
            formatted = formatted .. "ğŸ“° " .. line:gsub("^NEWS:%s*", "") .. " ğŸ“°\n"
        else
            formatted = formatted .. "â¤ " .. line .. "\n"
        end
        if i < #lines then formatted = formatted .. "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n" end
    end
    formatted = formatted .. "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\nUpdated: " .. os.date("%Y-%m-%d %H:%M UTC")
    return formatted
end
local function updateNews()
    spawn(function()
        local success, news = pcall(function()
            return game:HttpGet("https://pastebin.com/raw/vTKfsvCr")
        end)
        if success then
            newsParagraph:Set({Title = "ğŸ—ï¸ Vault Updates", Content = formatNews(news)})
        else
            newsParagraph:Set({Title = "ğŸ—ï¸ Vault Updates", Content = formatNews("Failed to fetch news!")})
        end
    end)
end
spawn(function() wait(1) updateNews() end)
spawn(function() while true do wait(60) updateNews() end end)

-- Subscription Tab (only for subscribed users)
local SubTab
if isSubscribed(LocalPlayer.UserId) then
    SubTab = Window:CreateTab("â­ Subscription", 4483362458)
    local subParagraph = SubTab:CreateParagraph({
        Title = "â­ Vault Elite",
        Content = "Checking subscription status..."
    })
    SubTab:CreateButton({
        Name = "ğŸ”— Renew Subscription",
        Callback = function()
            setclipboard("discord.com/invite/mwTHaCKzhw")
            Rayfield:Notify({Title = "â­ Subscription", Content = "Renew via Discord!", Duration = 5})
        end
    })
    SubTab:CreateButton({
        Name = "ğŸ© Load VIP Script",
        Callback = function()
            spawn(function()
                local success, err = pcall(function()
                    loadstring(game:HttpGet(vipScriptURL))()
                end)
                if success then
                    Rayfield:Notify({Title = "ğŸ© VIP", Content = "Exclusive script loaded!", Duration = 5})
                else
                    Rayfield:Notify({Title = "âŒ Error", Content = "VIP script failed: " .. err, Duration = 5})
                end
            end)
        end
    })
    local function updateSubStatus()
        if isSubscribed(LocalPlayer.UserId) then
            local expiry = subscribedUsers[LocalPlayer.UserId]
            local secondsLeft = expiry - os.time()
            local daysLeft = math.floor(secondsLeft / (24 * 60 * 60))
            local hoursLeft = math.floor((secondsLeft % (24 * 60 * 60)) / (60 * 60))
            subParagraph:Set({
                Content = "Status: Subscribed!\nPerks: Early updates, VIP scripts\nExpires in: " .. daysLeft .. " days, " .. hoursLeft .. " hours"
            })
            -- VIP Badge Notification (one-time on load)
            if not LocalPlayer:GetAttribute("VIPBadgeShown") then
                Rayfield:Notify({
                    Title = "â­ VIP Badge",
                    Content = "Welcome, Vault Elite Member!",
                    Duration = 10,
                    Image = 4483362458
                })
                LocalPlayer:SetAttribute("VIPBadgeShown", true)
            end
        end
    end
    spawn(function()
        wait(2)
        updateSubStatus()
        while true do
            wait(60)
            updateSubStatus()
        end
    end)
end

-- Challenges Tab
local ChallengeTab = Window:CreateTab("ğŸ† Challenges", 4483362458)
local challenges = {
    {name = "Login Streak", progress = 1, goal = 5, reward = "50 VC"},
    {name = "Feedback Pro", progress = 0, goal = 3, reward = "VIP Extension (1 day)"}
}
local function updateChallenges()
    local text = "ğŸ† Active Challenges ğŸ†\n"
    for i, challenge in ipairs(challenges) do
        text = text .. challenge.name .. ": " .. challenge.progress .. "/" .. challenge.goal .. " (Reward: " .. challenge.reward .. ")\n"
    end
    return text
end
local challengeParagraph = ChallengeTab:CreateParagraph({Title = "ğŸ¯ Goals", Content = updateChallenges()})
ChallengeTab:CreateButton({
    Name = "ğŸ”„ Refresh Progress",
    Callback = function()
        challenges[1].progress = math.min(challenges[1].progress + 1, challenges[1].goal)
        if challenges[1].progress == challenges[1].goal then
            Rayfield:Notify({Title = "ğŸ† Completed", Content = "Login Streak done! +50 VC (coming soon)", Duration = 5})
            challenges[1].progress = 0
        end
        challengeParagraph:Set({Content = updateChallenges()})
    end
})

-- Initialize
sendExecutionWebhook()
print("ComboChronicle Vault NextGen loaded!")
